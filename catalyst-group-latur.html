<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NVD Learning – Image Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="font-family: Arial, sans-serif; padding: 40px; background:#fafafa;">

  <h2>NVD Learning – Image Upload</h2>
  <p style="max-width:600px;">
    Upload images and copy the generated URL into the
    <b>image_url</b> column of your CSV.
  </p>

  <!-- Controls -->
  <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
    <button id="uploadBtn" style="padding:12px 18px; font-size:16px;">
      Upload Image(s)
    </button>

    <select id="sortSelect" style="padding:8px;">
      <option value="newest">Sort: Newest first</option>
      <option value="az">Sort: Filename A–Z</option>
    </select>
  </div>

  <!-- Search -->
  <div style="margin-top:20px;">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by filename (e.g. 45, Q45, logic)"
      style="padding:10px; width:100%; max-width:420px;"
    />
  </div>

  <!-- Summary -->
  <div id="summary"
       style="margin-top:12px; font-size:14px; color:#444;">
    Uploaded: 0 | Copied: 0 | Pending: 0
  </div>

  <!-- Grid -->
  <div id="grid"
       style="
         display:grid;
         grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));
         gap:16px;
         margin-top:25px;
       ">
  </div>

  <!-- Cloudinary -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <script>
    /* ================= CONFIG ================= */
    const CLOUD_NAME = "dpdbtl8on";          // <-- CHANGE
    const UPLOAD_PRESET = "catalyst-group-latur";    // <-- CHANGE

    /* ================= STATE ================= */
    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const summary = document.getElementById("summary");

    const uploadedFilenames = {};
    let cards = [];
    let copiedCount = 0;

    /* ================= WIDGET ================= */
    const widget = cloudinary.createUploadWidget(
      {
        cloudName: CLOUD_NAME,
        uploadPreset: UPLOAD_PRESET,
        multiple: true
      },
      (error, result) => {
        if (!error && result && result.event === "success") {
          addImageCard(result.info);
          updateSummary();
        }
      }
    );

    document.getElementById("uploadBtn").onclick = () => widget.open();

    /* ================= CARD CREATION ================= */
    function addImageCard(info) {
      const filenameLower = info.original_filename.toLowerCase();
      uploadedFilenames[filenameLower] =
        (uploadedFilenames[filenameLower] || 0) + 1;

      const card = document.createElement("div");
      card.style.border = "1px solid #ddd";
      card.style.padding = "10px";
      card.style.borderRadius = "8px";
      card.style.background = "#fff";
      card.style.textAlign = "center";
      card.dataset.filename = filenameLower;
      card.dataset.copied = "false";

      // Thumbnail
      const img = document.createElement("img");
      img.src = info.thumbnail_url;
      img.style.width = "100%";
      img.style.height = "120px";
      img.style.objectFit = "contain";

      // Filename
      const name = document.createElement("div");
      name.innerText = info.original_filename;
      name.style.marginTop = "6px";
      name.style.fontSize = "13px";
      name.style.fontWeight = "600";
      name.style.wordBreak = "break-all";

      // Duplicate warning
      let warning = null;
      if (uploadedFilenames[filenameLower] > 1) {
        warning = document.createElement("div");
        warning.innerText = "⚠ Duplicate filename";
        warning.style.color = "#b45309";
        warning.style.fontSize = "12px";
        warning.style.marginTop = "4px";
      }

      // Copy button (re-copy allowed)
      const btn = document.createElement("button");
      btn.innerText = "Copy URL";
      btn.style.marginTop = "8px";
      btn.style.padding = "6px 10px";
      btn.style.cursor = "pointer";

      btn.onclick = () => {
        navigator.clipboard.writeText(info.secure_url);
        if (card.dataset.copied === "false") {
          card.dataset.copied = "true";
          copiedCount++;
        }
        btn.innerText = "Copied ✓";
        btn.style.backgroundColor = "#16a34a";
        btn.style.color = "#fff";
        updateSummary();
      };

      card.appendChild(img);
      card.appendChild(name);
      if (warning) card.appendChild(warning);
      card.appendChild(btn);

      cards.push(card);
      renderCards();
    }

    /* ================= RENDER / SORT ================= */
    function renderCards() {
      grid.innerHTML = "";
      let sorted = [...cards];

      if (sortSelect.value === "az") {
        sorted.sort((a, b) =>
          a.dataset.filename.localeCompare(b.dataset.filename)
        );
      }

      sorted.forEach(card => grid.appendChild(card));
    }

    sortSelect.addEventListener("change", renderCards);

    /* ================= SEARCH ================= */
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      cards.forEach(card => {
        card.style.display =
          card.dataset.filename.includes(q) ? "" : "none";
      });
    });

    /* ================= SUMMARY ================= */
    function updateSummary() {
      const total = cards.length;
      const pending = total - copiedCount;
      summary.innerText =
        `Uploaded: ${total} | Copied: ${copiedCount} | Pending: ${pending}`;
    }
  </script>

</body>
</html>
